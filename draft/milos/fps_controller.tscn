[gd_scene load_steps=4 format=3 uid="uid://dwn4yi6l43rcc"]

[sub_resource type="GDScript" id="GDScript_h1svc"]
script/source = "extends CharacterBody3D

@onready var camera := $Head/Camera3D
@onready var head := $Head
@onready var shape := $CollisionShape3D/MeshInstance3D
@onready var right_collider := $Head/RightRaycast
@onready var left_collider := $Head/LeftRaycast

@export var WALK_SPEED = 4.0
@export var RUN_SPEED = 8.0
@export var  MASS = 4.0

var current_mass = MASS
const JUMP_VELOCITY = 15.0
var lock_timer = 0
var speed

#Camera stuff
var TILT_LOWER_LIMIT := deg_to_rad(-90.0)
var TILT_UPPER_LIMIT := deg_to_rad(90.0)
const SENSITIVITY = 0.004
const bob_frequency = 1.0
const bob_amplitude = 0.02
var time_bob = 0.0
var juice_modifier = 1.0
#fov variables
const BASE_FOV = 80.0
const FOV_CHANGE = 2.0

func _ready():
	Input.mouse_mode = Input.MOUSE_MODE_CAPTURED

func _unhandled_input(event) -> void:
	#handle the cammera
	if event is InputEventMouseMotion:
		head.rotate_y(-event.relative.x * SENSITIVITY)
		camera.rotate_x(-event.relative.y * SENSITIVITY)
		camera.rotation.x = clamp(camera.rotation.x, TILT_LOWER_LIMIT, TILT_UPPER_LIMIT)

func _physics_process(delta: float) -> void:
	var input_dir := Input.get_vector(\"move_left\", \"move_right\", \"move_forward\", \"move_backward\")
	var direction = (head.transform.basis * transform.basis * Vector3(input_dir.x, 0, input_dir.y)).normalized() 	
	
	if is_falling() and Input.is_action_pressed(\"jump\"):
		current_mass = MASS * 2 
		juice_modifier = 10.0
	else:
		current_mass = MASS
		juice_modifier = 1.0
	
	if not is_on_floor():
		if is_on_wall_on_either_side() and is_falling():
			velocity += get_gravity() * current_mass / 5 * delta
		else:
			velocity += get_gravity() * current_mass * delta
			
	# Handle sprint 
	if Input.is_action_pressed(\"sprint\"):
		speed = RUN_SPEED
	else:
		speed = WALK_SPEED

	
	if direction:
		if is_on_wall_only():
			speed = speed / 2
		else:
			velocity.x = direction.x * speed
			velocity.z = direction.z * speed
			
	else:
		velocity.x = lerp(velocity.x, direction.x * speed, delta * 7.0)
		velocity.z = lerp(velocity.z, direction.z * speed, delta * 7.0)
		
	# Handle jump.
	if Input.is_action_just_pressed(\"jump\"):
		if is_on_floor():
			velocity.y = JUMP_VELOCITY
		elif is_on_wall_on_either_side():
			velocity = get_wall_normal() * 10
			velocity.y += JUMP_VELOCITY
	
	add_juice(delta,speed)
	move_and_slide()
	
func is_falling() -> bool:
	return velocity.y < 0
	
func add_juice(delta, speed):
	#Bobbing
	time_bob += delta * velocity.length() * float(is_on_floor())
	#camera.transform.origin = headbob(time_bob)
	
	# FOV
	var velocity_clamped = clamp(velocity.length(), 0.5, speed * 2)
	var target_fov = BASE_FOV + FOV_CHANGE * velocity_clamped
	camera.fov = lerp(camera.fov, target_fov, delta * juice_modifier)
	
	
func is_on_wall_on_either_side() -> bool:
	return right_collider.is_colliding() || left_collider.is_colliding()
func headbob(time_bob):
	var position = Vector3.ZERO
	position.y = sin(time_bob * bob_frequency) * bob_amplitude
	position.x = cos(time_bob * bob_frequency / 2) * bob_amplitude
	return position
"

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_hbvfc"]

[sub_resource type="CapsuleMesh" id="CapsuleMesh_h3g6m"]

[node name="CharacterBody3D" type="CharacterBody3D"]
script = SubResource("GDScript_h1svc")

[node name="Body" type="CollisionShape3D" parent="."]
shape = SubResource("CapsuleShape3D_hbvfc")

[node name="MeshInstance3D" type="MeshInstance3D" parent="Body"]
layers = 512
mesh = SubResource("CapsuleMesh_h3g6m")

[node name="Head" type="Node3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0)

[node name="Camera3D" type="Camera3D" parent="Head"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.0634993, 0.125172, 0.203677)
cull_mask = 1048063

[node name="RightRaycast" type="RayCast3D" parent="Head"]
transform = Transform3D(-4.3711385e-08, -0.99999994, 0, 0.99999994, -4.3711385e-08, 0, 0, 0, 1, 0, -0.5, 0)
collision_mask = 7

[node name="LeftRaycast" type="RayCast3D" parent="Head"]
transform = Transform3D(1.192488e-08, 0.99999994, 0, -0.99999994, 1.192488e-08, 0, 0, 0, 1, 0, -0.5, 0)
collision_mask = 7
